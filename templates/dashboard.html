<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link rel="stylesheet" href="/static/fitness.css">
    <link rel="stylesheet" href="/static/trading.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script type="module" src="/static/main.js" defer></script>
    <script type="module" src="/static/fitness.js?v=1.1" defer></script>
    <script type="module" src="/static/work.js" defer></script>
    <script type="module" src="/static/trading.js" defer></script>
    <script type="module" src="/static/utils.js" defer></script>
    <script type="module" src="/static/workouts.js" defer></script>
    <script type="module" src="/static/activities.js"></script>
    <script type="module" src="/static/food.js"></script>
    
    <style>
        /* Food Sub-tabs */
        .food-sub-tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .food-sub-tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        
        .food-sub-tab-btn:hover {
            color: #007bff;
        }
        
        .food-sub-tab-content {
            display: none;
        }
        
        .food-sub-tab-content.active {
            display: block;
        }
        
        /* Barcode Scanner Styles */
        .barcode-scanner-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .barcode-scanner {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px auto;
            position: relative;
            overflow: hidden;
        }
        
        .barcode-scanner video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            border: 2px solid #007bff;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid rgba(0, 123, 255, 0.3);
            border-radius: 8px;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        
        .scanner-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .scanner-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .scanner-btn:hover {
            background: #218838;
        }
        
        .scanner-btn.stop {
            background: #dc3545;
        }
        
        .scanner-btn.stop:hover {
            background: #c82333;
        }
        
        .manual-barcode {
            text-align: center;
            margin: 20px 0;
        }
        
        .manual-barcode input {
            width: 200px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            margin-right: 10px;
        }
        
        .manual-barcode button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .manual-barcode button:hover {
            background: #0056b3;
        }
        
        /* Fasting Styles */
        .fasting-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .fasting-status {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid #e9ecef;
        }
        
        .fasting-timer {
            margin-bottom: 20px;
        }
        
        .fasting-timer h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .timer-display {
            font-size: 48px;
            font-weight: bold;
            color: #007bff;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }
        
        .duration-text {
            font-size: 16px;
            color: #666;
        }
        
        .fasting-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .fasting-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fasting-btn.start {
            background: #28a745;
            color: white;
        }
        
        .fasting-btn.start:hover {
            background: #218838;
        }
        
        .fasting-btn.stop {
            background: #dc3545;
            color: white;
        }
        
        .fasting-btn.stop:hover {
            background: #c82333;
        }
        
        .fasting-stats {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .fasting-stats h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .stat-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .fasting-history {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .fasting-history h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s ease;
        }
        
        .history-item:hover {
            background-color: #f8f9fa;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-date {
            font-size: 14px;
            color: #666;
        }
        
        .history-duration {
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
        }
        
        .no-history {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }
        
        .fasting-active .timer-display {
            color: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Distance Milestones Styles */
        .distance-milestones-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            border: 2px solid #e9ecef;
        }
        
        .milestone-selector {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .milestone-selector label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }
        
        .milestone-selector select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            min-width: 250px;
            background: white;
        }
        
        .milestone-progress {
            background: white;
            border-radius: 10px;
            padding: 25px;
            border: 2px solid #dee2e6;
        }
        
        .milestone-header h4 {
            color: #007bff;
            margin: 0 0 5px 0;
            font-size: 24px;
            font-weight: bold;
        }
        
        .milestone-header p {
            color: #666;
            margin: 0 0 20px 0;
            font-style: italic;
        }
        
        .progress-container {
            margin-bottom: 25px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid #dee2e6;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
            border-radius: 8px;
        }
        
        .milestone-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .stat-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        
        .milestone-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #007bff;
            color: #007bff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn-outline:hover {
            background: #007bff;
            color: white;
        }
        
        /* Workout Template Styles */
        .workout-template-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #f8f9fa;
            transition: all 0.2s ease;
        }
        
        .workout-template-item:hover {
            background: #e9ecef;
            border-color: #007bff;
        }
        
        .template-info h4 {
            margin: 0 0 4px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .template-info p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }
        
        .category-btn, .exercise-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }
        
        .category-btn:hover, .exercise-btn:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .category-btn.selected, .exercise-btn.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .activity-list-modern {
          display: flex;
          flex-direction: column;
          gap: 16px;
          margin-bottom: 24px;
        }
        .activity-card {
          display: flex;
          align-items: center;
          background: #fff;
          border-radius: 10px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.07);
          padding: 18px 20px;
          gap: 18px;
          transition: box-shadow 0.2s;
        }
        .activity-card:hover {
          box-shadow: 0 4px 16px rgba(0,123,255,0.10);
        }
        .activity-icon {
          font-size: 2em;
          margin-right: 16px;
          color: #007bff;
          flex-shrink: 0;
        }
        .activity-details {
          flex: 1;
          display: flex;
          flex-wrap: wrap;
          gap: 18px;
          align-items: center;
        }
        .activity-type {
          font-weight: bold;
          font-size: 1.1em;
          color: #333;
        }
        .activity-meta {
          display: flex;
          gap: 16px;
          font-size: 0.98em;
          color: #555;
        }
        .activity-meta span {
          display: flex;
          align-items: center;
          gap: 4px;
        }
        .activity-actions {
          display: flex;
          gap: 8px;
        }
        .activity-action-btn {
          background: #f1f3f6;
          border: none;
          border-radius: 6px;
          padding: 7px 14px;
          font-size: 0.95em;
          cursor: pointer;
          color: #007bff;
          transition: background 0.2s;
        }
        .activity-action-btn:hover {
          background: #e3eefd;
        }
        @media (max-width: 600px) {
          .activity-card {
            flex-direction: column;
            align-items: flex-start;
            padding: 14px 10px;
          }
          .activity-details {
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
          }
        }
        .activity-edit-btn, .activity-delete-btn {
          background: #f1f3f6;
          border: none;
          border-radius: 50%;
          width: 38px;
          height: 38px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.2em;
          transition: background 0.2s, box-shadow 0.2s;
          box-shadow: 0 1px 3px rgba(0,0,0,0.04);
          margin-left: 2px;
        }
        .activity-edit-btn:hover {
          background: #e3eefd;
          color: #007bff;
        }
        .activity-delete-btn {
          color: #dc3545 !important;
        }
        .activity-delete-btn:hover {
          background: #ffeaea;
          color: #fff;
        }
        .log-activity-btn-modern {
          font-size: 1.13em;
          padding: 12px 28px;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,123,255,0.07);
          background: linear-gradient(90deg, #007bff 0%, #4fc3f7 100%);
          color: #fff;
          font-weight: 600;
          border: none;
          transition: background 0.2s, box-shadow 0.2s;
        }
        .log-activity-btn-modern:hover {
          background: linear-gradient(90deg, #0056b3 0%, #0288d1 100%);
          box-shadow: 0 4px 16px rgba(0,123,255,0.13);
          color: #fff;
        }
        .log-activity-modal-modern .close:hover,
        #close-log-activity-modal:hover {
          color: #007bff;
        }
        .log-activity-modal-modern form label {
          font-weight: 500;
          color: #333;
        }
        .log-activity-modal-modern form input,
        .log-activity-modal-modern form select {
          border-radius: 6px;
          border: 1.5px solid #ddd;
          padding: 10px 12px;
          font-size: 1em;
          margin-bottom: 12px;
          width: 100%;
          box-sizing: border-box;
        }
        .log-activity-modal-modern form .form-group {
          margin-bottom: 14px;
        }
        .activity-flex-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 28px;
          margin-bottom: 32px;
        }
        @media (max-width: 900px) {
          .activity-flex-row {
            grid-template-columns: 1fr;
          }
        }
        .half-width-section {
          background: #fff;
          border-radius: 14px;
          box-shadow: 0 2px 12px rgba(30,41,59,0.07);
          padding: 24px 28px 20px 28px;
          box-sizing: border-box;
          max-width: 100%;
          min-width: 0;
        }
        .activity-action-row-minimal {
          display: flex;
          gap: 12px;
          align-items: center;
          margin-bottom: 18px;
        }
        .activity-pill-btn {
          display: flex;
          align-items: center;
          gap: 6px;
          background: #f6f8fa;
          color: #222;
          border: 1.5px solid #e0e4ea;
          border-radius: 999px;
          padding: 10px 22px;
          font-size: 1.08em;
          font-weight: 500;
          cursor: pointer;
          transition: background 0.18s, border 0.18s, color 0.18s;
          box-shadow: none;
          outline: none;
        }
        .activity-pill-btn:hover, .activity-pill-btn:focus {
          background: #e9f1ff;
          border-color: #b6d4fe;
        }
        .activity-pill-primary {
          background: #2563eb;
          color: #fff;
          border: none;
          font-weight: 600;
        }
        .activity-pill-primary:hover, .activity-pill-primary:focus {
          background: #1746a2;
        }
        .activity-pill-label {
          flex: 1;
          text-align: left;
        }
        .activity-pill-chevron {
          font-size: 1.1em;
          color: #888;
        }
        @media (max-width: 600px) {
          .activity-action-row-minimal {
            flex-direction: column;
            gap: 10px;
            align-items: stretch;
          }
        }

        .activity-level-option {
          background: #f6f8fa;
          color: #222;
          border: 1.5px solid #e0e4ea;
          border-radius: 8px;
          padding: 14px 18px;
          font-size: 1.08em;
          font-weight: 500;
          cursor: pointer;
          transition: background 0.18s, border 0.18s, color 0.18s;
          box-shadow: none;
          outline: none;
          text-align: left;
          margin-bottom: 0;
        }
        .activity-level-option:hover, .activity-level-option:focus {
          background: #e9f1ff;
          border-color: #b6d4fe;
          color: #1746a2;
        }
        .activity-title {
          font-weight: 600;
          font-size: 1.1em;
          margin-bottom: 2px;
        }
        .activity-desc {
          font-size: 0.97em;
          color: #666;
        }

        .miles-summary-card {
          background: #f8fafd;
          border-radius: 16px;
          box-shadow: 0 2px 12px rgba(30,41,59,0.07);
          padding: 28px 32px 22px 32px;
          margin-bottom: 18px;
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          min-width: 0;
        }
        .miles-summary-header {
          display: flex;
          align-items: center;
          gap: 12px;
          margin-bottom: 10px;
        }
        .miles-summary-header h3 {
          margin: 0;
          font-size: 1.18em;
          color: #2563eb;
          font-weight: 700;
        }
        .miles-summary-timeframe {
          margin-left: auto;
          display: flex;
          align-items: center;
          gap: 8px;
          background: #f1f5fa;
          border-radius: 999px;
          padding: 6px 14px;
          font-size: 1em;
          border: 1.5px solid #e0e4ea;
        }
        .miles-summary-timeframe label {
          font-weight: 500;
          color: #555;
          margin-right: 4px;
        }
        .miles-summary-timeframe select {
          border: none;
          background: transparent;
          font-size: 1em;
          color: #2563eb;
          font-weight: 600;
          outline: none;
          padding: 2px 0;
        }
        .miles-summary-stats {
          display: flex;
          gap: 18px;
          margin-top: 12px;
          margin-bottom: 8px;
        }
        .miles-summary-pill {
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 1px 4px rgba(30,41,59,0.06);
          padding: 18px 22px;
          display: flex;
          flex-direction: column;
          align-items: center;
          min-width: 110px;
          min-height: 80px;
          justify-content: center;
          border: 1.5px solid #e0e4ea;
        }
        .miles-summary-icon {
          font-size: 1.6em;
          margin-bottom: 4px;
        }
        .miles-summary-value {
          font-size: 1.35em;
          font-weight: 700;
          color: #2563eb;
          margin-bottom: 2px;
        }
        .miles-summary-label {
          font-size: 1em;
          color: #666;
          font-weight: 500;
        }
        .miles-summary-dates {
          font-size: 0.97em;
          color: #888;
          margin-top: 10px;
        }
        @media (max-width: 700px) {
          .miles-summary-card { padding: 16px 8px 12px 8px; }
          .miles-summary-stats { flex-direction: column; gap: 10px; }
          .miles-summary-pill { min-width: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">Dashboard</div>
            <div class="header-actions">
                {% if current_user.is_authenticated %}
                    <p>Welcome, {{ current_user.first_name }} {{ current_user.last_name }} ({{ current_user.email }})</p>
                    <div class="header-actions">
                        <a href="/profile" class="profile-link">Profile & Settings</a>
                        <a href="{{ url_for('logout') }}">Logout</a>
                    </div>
                {% else %}
                    <a href="{{ url_for('auth_google') }}">Sign in with Google</a>
                {% endif %}
            </div>
        </header>

        <div class="tabs">
            <button class="tab-button" data-tab="fitness">Fitness</button>
            <button class="tab-button" data-tab="trading">Trading</button>
            <button class="tab-button" data-tab="mood">Mood</button>
            <button class="tab-button" data-tab="work">Work</button>
        </div>

        <div id="trading" class="tab-content">
            <div class="sub-tabs">
                <button class="sub-tab-button active" data-trading-sub-tab="dashboard">Dashboard</button>
                <button class="sub-tab-button" data-trading-sub-tab="trades">Trades</button>
                <button class="sub-tab-button" data-trading-sub-tab="daily-review">Daily Review</button>
                <button class="sub-tab-button" data-trading-sub-tab="weekly-review">Weekly Review</button>
                <button class="sub-tab-button" data-trading-sub-tab="pnl">PnL Analysis</button>
            </div>
            <div id="trading-dashboard" class="sub-tab-content active">
                <h2>Trading Dashboard</h2>
                <p>Overview of your trading performance, stats, and charts will appear here.</p>
            </div>
            <div id="trading-trades" class="sub-tab-content">
                <h2>Record Trades</h2>
                <p>Add, view, and manage your trades in this section.</p>
            </div>
            <div id="trading-daily-review" class="sub-tab-content">
                <h2>Daily Review</h2>
                <p>Reflect on your daily trading activity and record your thoughts here.</p>
            </div>
            <div id="trading-weekly-review" class="sub-tab-content">
                <h2>Weekly Review</h2>
                <p>Summarize your weekly trading performance and lessons learned in this section.</p>
            </div>
            <div id="trading-pnl" class="sub-tab-content">
                <h2>PnL Analysis</h2>
                <p>Analyze your profit and loss over time with charts and statistics.</p>
            </div>
        </div>

        <div id="fitness" class="tab-content">
            <div class="sub-tabs">
                <div class="sub-tab-buttons">
                    <button class="sub-tab-button active" data-sub-tab="dashboard">Dashboard</button>
                    <button class="sub-tab-button" data-sub-tab="stats">Stats</button>
                    <button class="sub-tab-button" data-sub-tab="food">Food</button>
                    <button class="sub-tab-button" data-sub-tab="history">History</button>
                    <button class="sub-tab-button" data-sub-tab="activity">Activity</button>
                    <button class="sub-tab-button" data-sub-tab="motivation">Motivation</button>
                    <button class="sub-tab-button" data-sub-tab="leaderboard">Leaderboard</button>
                </div>
            </div>

            <div id="dashboard" class="sub-tab-content active">
                <h2>Fitness Dashboard</h2>
                
                <!-- Quick Stats Overview -->
                <div class="quick-stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">⚖️</div>
                        <div class="stat-content">
                            <h3>Current Weight</h3>
                            <div class="stat-value" id="current-weight">--</div>
                            <div class="stat-change" id="weight-change">--</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">🔥</div>
                        <div class="stat-content">
                            <h3>Today's Calories</h3>
                            <div class="stat-value" id="today-calories">--</div>
                            <div class="stat-target" id="calorie-target">Target: --</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">💪</div>
                        <div class="stat-content">
                            <h3>Workouts This Week</h3>
                            <div class="stat-value" id="weekly-workouts">--</div>
                            <div class="stat-target">Goal: 3-5</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">🎯</div>
                        <div class="stat-content">
                            <h3>Active Goals</h3>
                            <div class="stat-value" id="active-goals">--</div>
                            <div class="stat-target">Keep going!</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity-section">
                    <h3>Recent Activity</h3>
                    <div class="activity-timeline" id="activity-timeline">
                        <div class="timeline-item">
                            <div class="timeline-icon">📊</div>
                            <div class="timeline-content">
                                <h4>Weight Logged</h4>
                                <p>175.2 lbs - 2 days ago</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-icon">🏋️</div>
                            <div class="timeline-content">
                                <h4>Workout Completed</h4>
                                <p>Upper Body - 3 days ago</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-icon">🍎</div>
                            <div class="timeline-content">
                                <h4>Food Logged</h4>
                                <p>2,150 calories - 4 days ago</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions-section">
                    <h3>Quick Actions</h3>
                    <div class="actions-grid">
                        <button class="action-btn" onclick="switchToTab('stats')">
                            <div class="action-icon">📊</div>
                            <span>Log Weight</span>
                        </button>
                        <button class="action-btn" onclick="switchToTab('food')">
                            <div class="action-icon">🍎</div>
                            <span>Log Food</span>
                        </button>
                        <button class="action-btn" onclick="switchToActivityWorkouts()">
                            <div class="action-icon">🏋️</div>
                            <span>Log Workout</span>
                        </button>
                        <button class="action-btn" onclick="switchToTab('activity')">
                            <div class="action-icon">🏃</div>
                            <span>Log Activity</span>
                        </button>
                        <button class="action-btn" onclick="switchToTab('motivation')">
                            <div class="action-icon">💪</div>
                            <span>Set Goals</span>
                        </button>
                    </div>
                </div>

                <!-- Progress Charts -->
                <div class="progress-charts-section">
                    <h3>Progress Overview</h3>
                    <div class="charts-grid">
                        <div class="chart-card">
                            <h4>Weight Trend (Last 30 Days)</h4>
                            <div class="chart-placeholder" id="weight-chart">
                                <p>Chart will be displayed here</p>
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Calorie Intake (This Week)</h4>
                            <div class="chart-placeholder" id="calorie-chart">
                                <p>Chart will be displayed here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="stats" class="sub-tab-content">
                <h2>Stats & Progress Tracking</h2>
                
                <!-- Stats Entry Section -->
                <div class="stats-section" style="background: #fff; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 16px 0; color: #333; font-size: 1.3em;">📊 Log New Stats</h3>
                    <form id="stats-form" enctype="multipart/form-data">
                        <!-- Body Scan Upload -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="bodyscan_image" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Body Scan Image (Optional)</label>
                            <div id="bodyscan-form" style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px;">
                                <input type="file" id="bodyscan_image" name="bodyscan_image" accept="image/*" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                <button type="button" class="btn btn-primary" id="process-ocr-btn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Upload & Process</button>
                            </div>
                            <small style="color: #666; font-size: 0.8em;">Upload a body scan image to automatically extract measurements</small>
                        </div>

                        <!-- Progress Pictures -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">📸 Progress Pictures</label>
                            <p style="color: #666; margin-bottom: 12px; font-size: 0.9em;">Track your visual progress with photos</p>
                            <div id="progress-pic-form" style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
                                <input type="file" id="progress-pic-input" name="progress_pic" accept="image/*" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                <button type="button" class="btn btn-primary" id="progress-pic-upload-btn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Upload</button>
                            </div>
                            <div id="progress-pic-gallery" style="display: flex; flex-wrap: wrap; gap: 12px; max-height: 200px; overflow-y: auto; padding: 8px; background: #f8f9fa; border-radius: 6px;"></div>
                        </div>

                        <!-- Weight Input -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="weight" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Weight (lbs)</label>
                            <input type="number" id="weight" name="weight" step="0.1" style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                        </div>

                        <!-- Additional Measurements -->
                        <details class="measurements" style="margin-bottom: 20px;">
                            <summary style="cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 6px; font-weight: 500; color: #333;">📏 Additional Body Measurements</summary>
                            <div style="padding: 16px 0;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                    <div class="form-group">
                                        <label for="bicep_measurement" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #666;">Bicep (in)</label>
                                        <input type="number" id="bicep_measurement" name="bicep_measurement" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="chest_measurement" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #666;">Chest (in)</label>
                                        <input type="number" id="chest_measurement" name="chest_measurement" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="waist_measurement" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #666;">Waist (in)</label>
                                        <input type="number" id="waist_measurement" name="waist_measurement" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="butt_measurement" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #666;">Hips (in)</label>
                                        <input type="number" id="butt_measurement" name="butt_measurement" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <div class="form-group">
                                        <label for="quad_measurement" style="display: block; margin-bottom: 4px; font-size: 0.9em; color: #666;">Thigh (in)</label>
                                        <input type="number" id="quad_measurement" name="quad_measurement" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                </div>
                            </div>
                        </details>

                        <button type="submit" class="btn btn-primary" style="padding: 10px 20px; font-size: 1em;">Save Stats</button>
                    </form>
                </div>

                <!-- Stats History Section -->
                <div class="stats-section" style="background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 16px 0; color: #333; font-size: 1.3em;">📈 Stats History</h3>
                    <div style="overflow-x: auto;">
                        <table id="stats-table" style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Date</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Weight (lbs)</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Body Fat (%)</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">SMM (lbs)</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Body Fat Mass</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Lean Mass</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">BMR</th>
                                    <th style="padding: 12px 8px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="food" class="sub-tab-content">
                <h2>Food Tracker</h2>
                
                <!-- Food Sub-tabs -->
                <div class="food-sub-tabs" style="display: flex; gap: 16px; margin-bottom: 24px; border-bottom: 2px solid #eee; padding-bottom: 8px;">
                    <button class="food-sub-tab-btn active" data-food-tab="manual">Manual Entry</button>
                    <button class="food-sub-tab-btn" data-food-tab="barcode">Barcode Scanner</button>
                    <button class="food-sub-tab-btn" data-food-tab="fasting">Fasting Tracker</button>
                    <button class="food-sub-tab-btn" data-food-tab="database">Food Database</button>
                </div>

                <!-- Manual Entry Tab -->
                <div id="food-tab-manual" class="food-sub-tab-content active">
                    <!-- Manual Food Entry Form -->
                    <div class="manual-food-entry-section">
                        <h3>Daily Nutrition Input</h3>
                        <p>Enter your total daily calories and macros</p>
                        <form id="manual-food-form">
                            <input type="hidden" id="date" name="date">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="manual-calories">Total Calories:</label>
                                    <input type="number" id="manual-calories" name="calories" min="0" step="0.1" placeholder="0" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="manual-protein">Total Protein (g):</label>
                                    <input type="number" id="manual-protein" name="protein" min="0" step="0.1" placeholder="0">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="manual-carbs">Total Carbs (g):</label>
                                    <input type="number" id="manual-carbs" name="carbs" min="0" step="0.1" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label for="manual-fat">Total Fat (g):</label>
                                    <input type="number" id="manual-fat" name="fat" min="0" step="0.1" placeholder="0">
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Log Daily Nutrition</button>
                        </form>
                    </div>
                    
                    <!-- Daily Nutrition Summary -->
                    <div class="nutrition-summary">
                        <h3>Daily Nutrition Summary</h3>
                        <div id="nutrition-summary-display">
                            <p>Select a date to view nutrition summary</p>
                        </div>
                    </div>

                    <!-- Food Entries Table -->
                    <div class="food-entries-section">
                        <h3>Food Entries</h3>
                        <table id="food-entries-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Food Name</th>
                                    <th>Calories</th>
                                    <th>Protein (g)</th>
                                    <th>Carbs (g)</th>
                                    <th>Fat (g)</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Barcode Scanner Tab -->
                <div id="food-tab-barcode" class="food-sub-tab-content">
                    <div class="barcode-scanner-container">
                        <h3>Scan Barcode</h3>
                        <p>Scan a food barcode to quickly find and log products</p>
                        
                        <div class="barcode-scanner" id="barcode-scanner">
                            <video id="scanner-video" autoplay></video>
                            <div class="scanner-overlay"></div>
                        </div>
                        
                        <div class="scanner-controls">
                            <button class="scanner-btn" id="start-scanner">Start Scanner</button>
                            <button class="scanner-btn stop" id="stop-scanner" style="display: none;">Stop Scanner</button>
                        </div>
                        
                        <div class="manual-barcode">
                            <p>Or enter barcode manually:</p>
                            <input type="text" id="manual-barcode-input" placeholder="Enter barcode number...">
                            <button id="manual-barcode-button">Search</button>
                        </div>
                        
                        <div id="barcode-result"></div>
                    </div>
                </div>

                <!-- Fasting Tracker Tab -->
                <div id="food-tab-fasting" class="food-sub-tab-content">
                    <div class="fasting-container">
                        <h3>Fasting Tracker</h3>
                        <p>Track your intermittent fasting periods and monitor your progress.</p>
                        
                        <!-- Current Fast Status -->
                        <div id="current-fast-status" class="fasting-status">
                            <div class="fasting-timer">
                                <h4>Current Fast</h4>
                                <div id="fasting-timer-display" class="timer-display">--:--:--</div>
                                <div id="fasting-duration" class="duration-text">Not fasting</div>
                            </div>
                            
                            <div class="fasting-controls">
                                <button id="start-fast-btn" class="fast-btn start">Start Fast</button>
                                <button id="end-fast-btn" class="fast-btn end" style="display: none;">End Fast</button>
                            </div>
                        </div>
                        
                        <!-- Fasting Stats -->
                        <div class="fasting-stats">
                            <h4>Your Stats</h4>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">Total Fasts</span>
                                    <span id="total-fasts" class="stat-value">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Total Hours</span>
                                    <span id="total-hours" class="stat-value">0</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Longest Fast</span>
                                    <span id="longest-fast" class="stat-value">0h</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Average Fast</span>
                                    <span id="average-fast" class="stat-value">0h</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Fasting History -->
                        <div class="fasting-history">
                            <h4>Recent Fasts</h4>
                            <div id="fasting-history-list" class="history-list">
                                <p class="no-history">No fasting history yet. Start your first fast!</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Food Database Tab -->
                <div id="food-tab-database" class="food-sub-tab-content">
                    <div class="food-dashboard">
                        <div class="dashboard-header">
                            <h1>🍽️ Food Database</h1>
                            <p>Search, discover, and log your daily nutrition</p>
                        </div>
                        <!-- Quick Add Section -->
                        <div class="quick-add">
                            <h3>Quick Add Food</h3>
                            <form class="quick-add-form" id="quickAddForm">
                                <div class="form-group">
                                    <label for="foodName">Food Name</label>
                                    <input type="text" id="foodName" name="foodName" placeholder="e.g., Apple, Chicken Breast" required>
                                </div>
                                <div class="form-group">
                                    <label for="calories">Calories</label>
                                    <input type="number" id="calories" name="calories" placeholder="100" required>
                                </div>
                                <div class="form-group">
                                    <label for="protein">Protein (g)</label>
                                    <input type="number" id="protein" name="protein" placeholder="5" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="carbs">Carbs (g)</label>
                                    <input type="number" id="carbs" name="carbs" placeholder="20" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="fat">Fat (g)</label>
                                    <input type="number" id="fat" name="fat" placeholder="2" step="0.1">
                                </div>
                                <div class="form-group">
                                    <label for="quantity">Quantity</label>
                                    <input type="number" id="quantity" name="quantity" placeholder="1" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label for="unit">Unit</label>
                                    <select id="unit" name="unit">
                                        <option value="serving">Serving</option>
                                        <option value="g">Grams</option>
                                        <option value="oz">Ounces</option>
                                        <option value="cup">Cup</option>
                                        <option value="piece">Piece</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="quick-add-btn">Add Food</button>
                                </div>
                            </form>
                        </div>
                        <!-- Search Section -->
                        <div class="search-container">
                            <div class="search-header">
                                <h2>Search Food Database</h2>
                                <div class="search-stats" id="searchStats">
                                    <span id="totalFoods">0</span> foods in database
                                </div>
                            </div>
                            <div class="search-input-container">
                                <input type="text" class="search-input" id="searchInput" placeholder="Search for foods (e.g., apple, chicken, yogurt...)" autocomplete="off">
                                <button class="search-btn" id="searchBtn">Search</button>
                            </div>
                            <div class="search-filters">
                                <select class="filter-select" id="categoryFilter">
                                    <option value="">All Categories</option>
                                </select>
                                <select class="filter-select" id="sortBy">
                                    <option value="name">Sort by Name</option>
                                    <option value="calories">Sort by Calories</option>
                                    <option value="protein">Sort by Protein</option>
                                </select>
                            </div>
                        </div>
                        <!-- Results Section -->
                        <div class="results-container">
                            <div class="results-header">
                                <div class="results-count" id="resultsCount">No results</div>
                                <div class="view-toggle">
                                    <button class="view-btn active" data-view="grid">Grid</button>
                                    <button class="view-btn" data-view="list">List</button>
                                </div>
                            </div>
                            <div id="searchResults" class="food-grid">
                                <div class="loading">
                                    <div class="loading-spinner"></div>
                                    <p>Search for foods to get started...</p>
                                </div>
                            </div>
                        </div>
                        <!-- Recent Foods Section -->
                        <div class="recent-foods">
                            <h3>Recently Logged Foods</h3>
                            <div class="recent-list" id="recentFoods">
                                <p>No recent foods logged yet.</p>
                            </div>
                        </div>
                    </div>
                    <link rel="stylesheet" href="/static/styles.css">
                    <script src="/static/food_enhanced.js"></script>
                    <script>
                        function activateFoodEnhancedTab() {
                            if (!window.foodEnhancedInitialized) {
                                window.initFoodEnhanced();
                                window.foodEnhancedInitialized = true;
                            }
                        }
                        // If the tab is active on page load
                        if (document.getElementById('food-tab-database').classList.contains('active')) {
                            activateFoodEnhancedTab();
                        }
                        // Listen for tab activation
                        document.querySelectorAll('.food-sub-tab-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                if (this.dataset.foodTab === 'database') {
                                    activateFoodEnhancedTab();
                                }
                            });
                        });
                    </script>
                </div>
            </div>

            <!-- Edit Food Entry Modal -->
            <div id="edit-food-modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Edit Food Entry</h2>
                    <form id="edit-food-form">
                        <input type="hidden" id="edit-food-id" name="id">
                        <div class="form-group">
                            <label for="edit-food-date">Date</label>
                            <input type="date" id="edit-food-date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-food-name">Food Name</label>
                            <input type="text" id="edit-food-name" name="food_name" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-food-calories">Calories</label>
                            <input type="number" id="edit-food-calories" name="calories" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-food-protein">Protein (g)</label>
                            <input type="number" id="edit-food-protein" name="protein" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-food-carbs">Carbs (g)</label>
                            <input type="number" id="edit-food-carbs" name="carbs" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-food-fat">Fat (g)</label>
                            <input type="number" id="edit-food-fat" name="fat" min="0" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-food-quantity">Quantity</label>
                            <input type="number" id="edit-food-quantity" name="quantity" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-food-unit">Unit</label>
                            <select id="edit-food-unit" name="unit" required>
                                <option value="manual">Manual</option>
                                <option value="serving">Serving</option>
                                <option value="g">Grams</option>
                                <option value="oz">Ounces</option>
                                <option value="ml">Milliliters</option>
                            </select>
                        </div>
                        <div class="modal-buttons">
                            <button type="submit" class="modal-button">Update</button>
                            <button type="button" class="modal-button cancel">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="activity" class="sub-tab-content">
                <!-- Activity Sub-tabs -->
                <div class="activity-sub-tabs" style="display: flex; gap: 16px; margin-bottom: 24px;">
                    <button class="activity-sub-tab-btn active" id="activity-sub-tab-activities">Activities</button>
                    <button class="activity-sub-tab-btn" id="activity-sub-tab-workouts">Workouts</button>
                </div>

                <!-- Activities Sub-tab Content -->
                <div id="activity-sub-content-activities" class="activity-sub-content active" style="display: block;">
                    <div class="activity-action-row-minimal">
                      <button id="daily-activity-level-btn" type="button" class="activity-pill-btn">
                        <span class="activity-pill-label">Sedentary</span>
                        <span class="activity-pill-chevron">&#9662;</span>
                      </button>
                      <input type="hidden" id="daily-activity-level" name="daily_activity_level" value="sedentary">
                      <button id="open-log-activity-modal" class="activity-pill-btn activity-pill-primary">
                        <span style="font-size:1.15em; margin-right: 6px;">&#43;</span> Log Activity
                      </button>
                    </div>
                    <style>
                    .activity-action-row-minimal {
                      display: flex;
                      gap: 12px;
                      align-items: center;
                      margin-bottom: 18px;
                    }
                    .activity-pill-btn {
                      display: flex;
                      align-items: center;
                      gap: 6px;
                      background: #f6f8fa;
                      color: #222;
                      border: 1.5px solid #e0e4ea;
                      border-radius: 999px;
                      padding: 10px 22px;
                      font-size: 1.08em;
                      font-weight: 500;
                      cursor: pointer;
                      transition: background 0.18s, border 0.18s, color 0.18s;
                      box-shadow: none;
                      outline: none;
                    }
                    .activity-pill-btn:hover, .activity-pill-btn:focus {
                      background: #e9f1ff;
                      border-color: #b6d4fe;
                    }
                    .activity-pill-primary {
                      background: #2563eb;
                      color: #fff;
                      border: none;
                      font-weight: 600;
                    }
                    .activity-pill-primary:hover, .activity-pill-primary:focus {
                      background: #1746a2;
                    }
                    .activity-pill-label {
                      flex: 1;
                      text-align: left;
                    }
                    .activity-pill-chevron {
                      font-size: 1.1em;
                      color: #888;
                    }
                    @media (max-width: 600px) {
                      .activity-action-row-minimal {
                        flex-direction: column;
                        gap: 10px;
                        align-items: stretch;
                      }
                    }
                    </style>
                    <!-- Modal for activity level selection -->
                    <div id="activity-level-modal" class="modal" style="display:none; background: rgba(0,0,0,0.18); align-items: center; justify-content: center;">
                        <div class="modal-content" style="max-width: 400px; margin: 40px auto; padding: 28px 24px 20px 24px; border-radius: 14px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); background: #fff; position: relative;">
                            <span class="close" id="close-activity-level-modal" style="position: absolute; right: 16px; top: 10px; font-size: 1.4em; cursor: pointer;">&times;</span>
                            <h3 style="margin-bottom: 18px;">Select Today's Activity Level</h3>
                            <div style="display: flex; flex-direction: column; gap: 14px;">
                              <button class="activity-level-option" data-value="sedentary">
                                <div class="activity-title">Sedentary</div>
                                <div class="activity-desc">(desk job or mostly sitting all day, little movement outside of logged exercise)</div>
                              </button>
                              <button class="activity-level-option" data-value="light">
                                <div class="activity-title">Light</div>
                                <div class="activity-desc">(on your feet a bit—teacher, retail, errands—but not physically strenuous)</div>
                              </button>
                              <button class="activity-level-option" data-value="moderate">
                                <div class="activity-title">Moderate</div>
                                <div class="activity-desc">(on your feet most of the day—waiter, nurse, warehouse worker—or a lot of walking)</div>
                              </button>
                              <button class="activity-level-option" data-value="active">
                                <div class="activity-title">Active</div>
                                <div class="activity-desc">(very physically demanding job—construction, mover—or lots of unlogged physical activity)</div>
                              </button>
                              <button class="activity-level-option" data-value="very_active">
                                <div class="activity-title">Very Active</div>
                                <div class="activity-desc">(athlete, military, or extremely physical job plus extra activity)</div>
                              </button>
                            </div>
                        </div>
                    </div>
                    <!-- Log Activity Button and Modal -->
                    <div style="display: flex; justify-content: flex-end; margin-bottom: 18px;">
                    </div>
                    <div id="log-activity-modal" class="modal" style="display:none; background: rgba(0,0,0,0.25); align-items: center; justify-content: center;">
                      <div class="modal-content log-activity-modal-modern" style="max-width: 420px; margin: 40px auto; padding: 0 0 20px 0; border-radius: 18px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); background: #fff; position: relative;">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 22px 28px 10px 28px; border-bottom: 1.5px solid #f0f0f0; border-radius: 18px 18px 0 0;">
                          <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em; color: #007bff;">🏃‍♂️</span>
                            <span style="font-size: 1.18em; font-weight: 600; color: #222;">Log Activity</span>
                          </div>
                          <button type="button" id="close-log-activity-modal" aria-label="Close" style="background: none; border: none; font-size: 1.7em; color: #888; cursor: pointer; transition: color 0.2s;"><span>&times;</span></button>
                        </div>
                        <form id="activity-form" style="padding: 24px 28px 0 28px;">
                          <!-- Modern Today's Activity Level -->
                          <!--
                          <div class="form-group" style="margin-bottom: 18px;">
                            <label for="daily-activity-level" style="font-weight: 600; color: #222; display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                              <span style="font-size: 1.15em; color: #43a047;">💡</span> Today's Activity Level
                            </label>
                            <select id="daily-activity-level" name="daily_activity_level" style="border-radius: 6px; border: 1.5px solid #ddd; padding: 10px 12px; font-size: 1em; width: 100%;">
                              <option value="sedentary" selected>Sedentary (desk job or mostly sitting all day, little movement outside of logged exercise)</option>
                              <option value="light">Light (on your feet a bit—teacher, retail, errands—but not physically strenuous)</option>
                              <option value="moderate">Moderate (on your feet most of the day—waiter, nurse, warehouse worker—or a lot of walking)</option>
                              <option value="active">Active (very physically demanding job—construction, mover—or lots of unlogged physical activity)</option>
                              <option value="very_active">Very Active (athlete, military, or extremely physical job plus extra activity)</option>
                            </select>
                            <small class="form-text text-muted" style="color: #888; font-size: 0.97em; margin-top: 4px; display: block;">Tip: Most users should select <b>Sedentary</b> or <b>Light</b> if all exercise is logged. Use higher levels only if your job or lifestyle is physically demanding in addition to your workouts.</small>
                          </div>
                          -->
                          <!-- End Modern Today's Activity Level -->
                          <input type="hidden" id="activity-date" name="activity_date">
                          <div class="form-group">
                            <label for="activity-type">Activity Type *</label>
                            <select id="activity-type" name="activity_type" required>
                              <option value="">Select Activity</option>
                              <option value="Walking">Walking</option>
                              <option value="Cycling">Cycling</option>
                              <option value="Mowing Lawn">Mowing Lawn</option>
                              <option value="Running">Running</option>
                              <option value="Strength Training">Strength Training</option>
                              <option value="Other">Other</option>
                            </select>
                            <input type="text" id="custom-activity-type" name="custom_activity_type" placeholder="Enter custom activity" style="display: none;">
                          </div>
                          <div class="form-group">
                            <label for="duration">Duration (minutes) *</label>
                            <input type="number" id="duration" name="duration" step="0.1" required>
                          </div>
                          <div class="form-group" id="miles-group" style="display: none;">
                            <label for="miles">Distance (miles)</label>
                            <input type="number" id="miles" name="miles" step="0.1" min="0">
                          </div>
                          <div class="form-group">
                            <label for="intensity">Intensity *</label>
                            <select id="intensity" name="intensity" required>
                              <option value="">Select Intensity</option>
                              <option value="Low">Low</option>
                              <option value="Moderate">Moderate</option>
                              <option value="High">High</option>
                            </select>
                          </div>
                          <div style="display: flex; gap: 14px; margin-top: 22px; justify-content: flex-end;">
                            <button type="submit" id="save-activity-btn" class="btn btn-primary">Save Activity</button>
                            <button type="button" class="btn btn-secondary" id="cancel-activity-btn">Cancel</button>
                          </div>
                        </form>
                      </div>
                    </div>
                    <!-- End Log Activity Modal -->

                    <!-- Distance Milestones Section -->
                    <div class="distance-milestones-section">
                        <h3>Distance Milestones</h3>
                        <div class="milestone-selector">
                            <label for="milestone-trail">Choose Your Trail:</label>
                            <select id="milestone-trail" name="milestone_trail">
                                <option value="">Select a famous trail</option>
                                <option value="appalachian">Appalachian Trail (2,190 miles)</option>
                                <option value="pacific_crest">Pacific Crest Trail (2,650 miles)</option>
                                <option value="continental_divide">Continental Divide Trail (3,100 miles)</option>
                                <option value="camino_santiago">Camino de Santiago (500 miles)</option>
                                <option value="john_muir">John Muir Trail (211 miles)</option>
                                <option value="tahoe_rim">Tahoe Rim Trail (165 miles)</option>
                                <option value="wonderland">Wonderland Trail (93 miles)</option>
                                <option value="angels_landing">Angels Landing (5.4 miles)</option>
                            </select>
                            <button id="set-milestone-btn" class="btn btn-secondary">Set Milestone</button>
                        </div>
                        
                        <div id="current-milestone" class="milestone-progress" style="display: none;">
                            <div class="milestone-header">
                                <h4 id="milestone-name">Appalachian Trail</h4>
                                <p id="milestone-description">Hike from Georgia to Maine across 14 states</p>
                            </div>
                            
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span id="progress-text">0 / 2,190 miles</span>
                                    <span id="progress-percentage">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="milestone-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Distance:</span>
                                    <span id="total-distance" class="stat-value">2,190 miles</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Completed:</span>
                                    <span id="completed-distance" class="stat-value">0 miles</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Remaining:</span>
                                    <span id="remaining-distance" class="stat-value">2,190 miles</span>
                                </div>
                            </div>
                            
                            <div class="milestone-actions">
                                <button id="change-milestone-btn" class="btn btn-outline">Change Trail</button>
                                <button id="reset-milestone-btn" class="btn btn-outline">Reset Progress</button>
                            </div>
                        </div>
                    </div>

                    <!-- Add this above the miles summary input and results -->
                    <div class="activity-flex-row">
                      <div class="miles-summary-section half-width-section">
                        <div class="miles-summary-card">
                          <div class="miles-summary-header">
                            <h3 style="margin: 0 0 12px 0; color: #222; font-size: 1.13em; font-weight: 600;">Miles Summary</h3>
                            <div class="miles-summary-timeframe">
                              <label for="miles-timeframe">Timeframe:</label>
                              <select id="miles-timeframe">
                                <option value="1">Today</option>
                                <option value="7">Last 7 days</option>
                                <option value="30">Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last 365 days</option>
                              </select>
                            </div>
                          </div>
                          <div style="color: #666; font-size: 1em; margin-bottom: 8px;">View your total miles by activity type for a selected timeframe.</div>
                          <div id="miles-summary-results" style="margin-top: 10px;"></div>
                        </div>
                      </div>
                      <div class="today-activities-section half-width-section">
                        <h3>Today's Activities</h3>
                        <div id="total-calories-burned"></div>
                        <div id="activity-list" class="activity-list-modern"></div>
                      </div>
                    </div>

                    <h3>TDEE Summary</h3>
                    <div id="tdee-summary">
                        <button id="record-tdee-btn" class="btn">Record Today's TDEE</button>
                    </div>

                    <h3 style="margin-top: 32px;">TDEE History</h3>
                    <div style="color: #666; font-size: 1em; margin-bottom: 10px;">See your historical Total Daily Energy Expenditure (TDEE), calorie intake, and energy balance. Use this to spot trends and track your progress over time.</div>
                    <canvas id="tdee-chart"></canvas>
                    <table id="tdee-history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th title="Basal Metabolic Rate (your body's energy use at rest)">BMR (kcal)<br><span style='font-weight:normal;font-size:0.9em;color:#888;'>(resting)</span></th>
                                <th title="Base TDEE is your estimated daily calories burned from your activity level, not including workouts.">Base TDEE<br><span style='font-weight:normal;font-size:0.9em;color:#888;'>(activity level only)</span></th>
                                <th title="Calories burned from logged workouts.">Workout Calories<br><span style='font-weight:normal;font-size:0.9em;color:#888;'>(from workouts)</span></th>
                                <th title="Total Daily Energy Expenditure (your total calories burned for the day)">TDEE (kcal)<br><span style='font-weight:normal;font-size:0.9em;color:#888;'>(total)</span></th>
                                <th title="Calories you ate/logged for the day.">Calorie Intake<br><span style='font-weight:normal;font-size:0.9em;color:#888;'>(eaten)</span></th>
                                <th title="Calorie Intake minus TDEE. Negative = deficit, positive = surplus.">Balance<br><span style='font-weight:normal;font-size:0.9em;color:#888;'>(intake - TDEE)</span></th>
                                <th title="Whether you were in a deficit, surplus, or maintenance.">Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tdee-history-tbody"></tbody>
                    </table>

                    <div id="edit-activity-modal" class="modal">
                        <div class="modal-content">
                            <span class="close">×</span>
                            <h2>Edit Activity</h2>
                            <form id="edit-activity-form">
                                <input type="hidden" id="edit-activity-id" name="id">
                                <input type="hidden" id="edit-activity-date" name="activity_date">
                                <input type="hidden" id="edit-miles" name="miles">
                                <div class="form-group">
                                    <label for="edit-activity-type">Activity Type *</label>
                                    <select id="edit-activity-type" name="activity_type" required>
                                        <option value="">Select Activity</option>
                                        <option value="Walking">Walking</option>
                                        <option value="Cycling">Cycling</option>
                                        <option value="Mowing Lawn">Mowing Lawn</option>
                                        <option value="Running">Running</option>
                                        <option value="Strength Training">Strength Training</option>
                                        <option value="Other">Other</option>
                                    </select>
                                    <input type="text" id="edit-custom-activity-type" name="custom_activity_type" placeholder="Enter custom activity" style="display: none;">
                                </div>
                                <div class="form-group">
                                    <label for="edit-duration">Duration (minutes) *</label>
                                    <input type="number" id="edit-duration" name="duration" step="0.1" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-intensity">Intensity *</label>
                                    <select id="edit-intensity" name="intensity" required>
                                        <option value="">Select Intensity</option>
                                        <option value="Low">Low</option>
                                        <option value="Moderate">Moderate</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>
                                <div class="modal-buttons" style="display: flex; gap: 14px; margin-top: 22px; justify-content: flex-end;">
                                    <button type="submit" class="btn btn-primary">Update Activity</button>
                                    <button type="button" class="btn btn-secondary cancel">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Workouts Sub-tab Content -->
                <div id="activity-sub-content-workouts" class="activity-sub-content" style="display: none;">
                    <nav class="workout-tabs" style="display: flex; gap: 16px; margin-bottom: 24px;">
                        <button class="workout-tab-btn active" id="workout-tab-new">Start New Workout</button>
                        <button class="workout-tab-btn" id="workout-tab-history">History</button>
                    </nav>
                    <div id="workout-tab-content-new">
                        <div style="text-align: center; margin-bottom: 24px; display: flex; gap: 16px; justify-content: center;">
                            <button id="log-exercise-btn" class="btn btn-primary" style="font-size: 1.1em; padding: 12px 24px;">
                                Log an Exercise
                            </button>
                            <button id="start-workout-btn" class="btn btn-secondary" style="font-size: 1.1em; padding: 12px 24px;">
                                Start a Workout
                            </button>
                        </div>
                        <div id="workout-modal" class="modal" style="display:none; background: rgba(0,0,0,0.25); align-items: center; justify-content: center;">
                            <div class="modal-content" style="max-width: 420px; margin: 40px auto; padding: 32px 28px 20px 28px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); background: #fff; position: relative;">
                                <span class="close" id="close-workout-modal" style="position: absolute; right: 18px; top: 12px; font-size: 1.6em; cursor: pointer;">&times;</span>
                                <div style="text-align: center; margin-bottom: 18px;">
                                    <h2 style="margin: 0 0 6px 0; font-size: 1.5em;">Log an Exercise</h2>
                                    <div id="modal-step-indicator" style="font-size: 1em; color: #888; margin-bottom: 8px;">Step 1 of 2</div>
                                </div>
                                <div id="modal-step-category">
                                    <h3 style="margin-bottom: 12px; font-size: 1.1em;">Select a Category</h3>
                                    <div id="category-list" style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; justify-content: center;"></div>
                                </div>
                                <div id="modal-step-exercise" style="display:none;">
                                    <h3 style="margin-bottom: 12px; font-size: 1.1em;">Select an Exercise</h3>
                                    <div id="exercise-list" style="display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; justify-content: center;"></div>
                                    <button type="button" id="show-custom-exercise-form" class="btn btn-secondary" style="margin-bottom: 16px;">+ Create New Exercise</button>
                                    <form id="custom-exercise-form" class="modern-form" style="display:none; margin-bottom: 16px;">
                                        <h4 style="margin-bottom: 8px;">Create Custom Exercise</h4>
                                        <div class="form-group">
                                            <label for="custom-exercise-name">Exercise Name*</label>
                                            <input type="text" id="custom-exercise-name" name="name" required maxlength="100" class="form-input" placeholder="Enter exercise name">
                                        </div>
                                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                                            <button type="submit" class="btn btn-primary">Create Exercise</button>
                                        </div>
                                    </form>
                                    <div style="display: flex; justify-content: space-between; gap: 12px;">
                                        <button type="button" id="back-to-category" class="btn btn-secondary" style="flex: 1;">Back</button>
                                        <button type="button" id="cancel-workout-btn" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="workout-history-section" id="workout-today-section">
                            <h2>Today's Workout</h2>
                            <table id="workout-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Exercise</th>
                                        <th>Set</th>
                                        <th>Total Weight</th>
                                        <th>Reps</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="workout-tab-content-history" style="display:none;">
                        <h2>Full Workout History</h2>
                        <table id="full-workout-history-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Exercise</th>
                                    <th>Weight (lbs)</th>
                                    <th>Reps</th>
                                    <th>Sets</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="motivation" class="sub-tab-content">
            <h2>Motivation Hub</h2>
            
            <!-- Daily Motivation Quote -->
            <div class="motivation-quote-section">
                <h3>Daily Motivation</h3>
                <div class="quote-card">
                    <blockquote id="daily-quote">
                        "The only bad workout is the one that didn't happen."
                    </blockquote>
                    <cite id="quote-author">- Unknown</cite>
                </div>
                <button id="refresh-quote-btn" class="btn btn-secondary">New Quote</button>
            </div>

            <!-- Goal Setting -->
            <div class="goal-setting-section">
                <h3>Fitness Goals</h3>
                <form id="goal-form">
                    <div class="form-group">
                        <label for="goal-type">Goal Type</label>
                        <select id="goal-type" name="goal_type" required>
                            <option value="">Select Goal Type</option>
                            <option value="weight">Weight Goal</option>
                            <option value="strength">Strength Goal</option>
                            <option value="endurance">Endurance Goal</option>
                            <option value="body_composition">Body Composition</option>
                            <option value="custom">Custom Goal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="goal-description">Goal Description</label>
                        <textarea id="goal-description" name="goal_description" placeholder="Describe your fitness goal..." required></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="goal-target">Target Value</label>
                            <input type="text" id="goal-target" name="goal_target" placeholder="e.g., 180 lbs, 225 bench press">
                        </div>
                        <div class="form-group">
                            <label for="goal-deadline">Target Date</label>
                            <input type="date" id="goal-deadline" name="goal_deadline">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Goal</button>
                </form>
            </div>

            <!-- Progress Tracking -->
            <div class="progress-tracking-section">
                <h3>Goal Progress</h3>
                <div id="goals-list">
                    <p>No goals set yet. Add your first goal above!</p>
                </div>
            </div>

            <!-- Motivation Tips -->
            <div class="motivation-tips-section">
                <h3>Motivation Tips</h3>
                <div class="tips-grid">
                    <div class="tip-card">
                        <h4>🎯 Set SMART Goals</h4>
                        <p>Specific, Measurable, Achievable, Relevant, and Time-bound goals are more likely to be achieved.</p>
                    </div>
                    <div class="tip-card">
                        <h4>📊 Track Progress</h4>
                        <p>Regularly monitor your progress to stay motivated and adjust your approach as needed.</p>
                    </div>
                    <div class="tip-card">
                        <h4>🏆 Celebrate Small Wins</h4>
                        <p>Recognize and celebrate every milestone, no matter how small. Progress is progress!</p>
                    </div>
                    <div class="tip-card">
                        <h4>💪 Consistency Over Perfection</h4>
                        <p>Focus on showing up consistently rather than being perfect. Small daily actions compound over time.</p>
                    </div>
                    <div class="tip-card">
                        <h4>🧠 Mindset Matters</h4>
                        <p>Your mindset determines your success. Focus on growth and learning from setbacks.</p>
                    </div>
                    <div class="tip-card">
                        <h4>🤝 Find Your Community</h4>
                        <p>Surround yourself with like-minded people who support your fitness journey.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="leaderboard" class="sub-tab-content">
            <h2>🏆 Fitness Leaderboard</h2>
            <div id="leaderboard-table-container">
                <!-- Leaderboard table will be rendered here -->
            </div>
        </div>
    </div>

    <div id="mood" class="tab-content">
        <div class="sub-tabs mood-sub-tabs">
            <button class="sub-tab-button mood-sub-tab-button active" data-mood-sub-tab="journal">Journal & Reflection</button>
        </div>
        <div id="mood-journal-tab" class="mood-sub-tab-content active">
            <!-- Daily Mood Entry -->
            <div class="mood-entry-section">
                <h3>Today's Mood Check-in</h3>
                <form id="mood-entry-form">
                    <div class="mood-rating-section">
                        <label>How are you feeling today?</label>
                        <div class="mood-scale">
                            <div class="mood-option" data-rating="1">
                                <span class="mood-emoji">😢</span>
                                <span class="mood-label">Terrible</span>
                            </div>
                            <div class="mood-option" data-rating="2">
                                <span class="mood-emoji">😞</span>
                                <span class="mood-label">Bad</span>
                            </div>
                            <div class="mood-option" data-rating="3">
                                <span class="mood-emoji">😐</span>
                                <span class="mood-label">Okay</span>
                            </div>
                            <div class="mood-option" data-rating="4">
                                <span class="mood-emoji">🙂</span>
                                <span class="mood-label">Good</span>
                            </div>
                            <div class="mood-option" data-rating="5">
                                <span class="mood-emoji">😊</span>
                                <span class="mood-label">Great</span>
                            </div>
                            <div class="mood-option" data-rating="6">
                                <span class="mood-emoji">😄</span>
                                <span class="mood-label">Amazing</span>
                            </div>
                            <div class="mood-option" data-rating="7">
                                <span class="mood-emoji">🤩</span>
                                <span class="mood-label">Ecstatic</span>
                            </div>
                        </div>
                        <input type="hidden" id="mood-rating" name="mood_rating" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="mood-category">Primary Mood</label>
                            <select id="mood-category" name="mood_category" required>
                                <option value="">Select Mood</option>
                                <option value="happy">Happy</option>
                                <option value="calm">Calm</option>
                                <option value="excited">Excited</option>
                                <option value="anxious">Anxious</option>
                                <option value="stressed">Stressed</option>
                                <option value="tired">Tired</option>
                                <option value="sad">Sad</option>
                                <option value="angry">Angry</option>
                                <option value="frustrated">Frustrated</option>
                                <option value="grateful">Grateful</option>
                                <option value="content">Content</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="energy-level">Energy Level</label>
                            <select id="energy-level" name="energy_level" required>
                                <option value="">Select Energy</option>
                                <option value="1">Very Low</option>
                                <option value="2">Low</option>
                                <option value="3">Moderate</option>
                                <option value="4">High</option>
                                <option value="5">Very High</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="sleep-quality">Sleep Quality (1-10)</label>
                            <input type="number" id="sleep-quality" name="sleep_quality" min="1" max="10" placeholder="How well did you sleep?">
                        </div>
                        <div class="form-group">
                            <label for="stress-level">Stress Level (1-10)</label>
                            <input type="number" id="stress-level" name="stress_level" min="1" max="10" placeholder="How stressed are you?">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="mood-triggers">What influenced your mood today?</label>
                        <textarea id="mood-triggers" name="mood_triggers" placeholder="Work, relationships, health, weather, events, etc..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="gratitude">What are you grateful for today?</label>
                        <textarea id="gratitude" name="gratitude" placeholder="Big or small things that made you thankful..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="challenges">What challenges did you face today?</label>
                        <textarea id="challenges" name="challenges" placeholder="Difficulties, setbacks, or things that were hard..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="wins">What went well today?</label>
                        <textarea id="wins" name="wins" placeholder="Accomplishments, positive moments, or things you're proud of..." rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="coping-strategies">How did you cope with challenges?</label>
                        <textarea id="coping-strategies" name="coping_strategies" placeholder="What helped you get through difficult moments?" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="tomorrow-intentions">What are your intentions for tomorrow?</label>
                        <textarea id="tomorrow-intentions" name="tomorrow_intentions" placeholder="Goals, mindset, or things you want to focus on..." rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Mood Entry</button>
                </form>
            </div>
            <!-- Mood History & Patterns -->
            <div class="mood-history-section">
                <h3>Mood History & Patterns</h3>
                <div class="mood-stats-grid">
                    <div class="mood-stat-card">
                        <h4>Average Mood This Week</h4>
                        <div class="mood-stat-value" id="weekly-avg-mood">--</div>
                        <div class="mood-stat-trend" id="weekly-mood-trend">--</div>
                    </div>
                    <div class="mood-stat-card">
                        <h4>Most Common Mood</h4>
                        <div class="mood-stat-value" id="common-mood">--</div>
                        <div class="mood-stat-detail" id="mood-frequency">--</div>
                    </div>
                    <div class="mood-stat-card">
                        <h4>Sleep Quality</h4>
                        <div class="mood-stat-value" id="avg-sleep">--</div>
                        <div class="mood-stat-detail">out of 10</div>
                    </div>
                    <div class="mood-stat-card">
                        <h4>Stress Level</h4>
                        <div class="mood-stat-value" id="avg-stress">--</div>
                        <div class="mood-stat-detail">out of 10</div>
                    </div>
                </div>

                <div class="mood-charts-section">
                    <div class="chart-container">
                        <h4>Mood Trend (Last 30 Days)</h4>
                        <div class="chart-placeholder" id="mood-trend-chart">
                            <p>Mood trend chart will be displayed here</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4>Mood Distribution</h4>
                        <div class="chart-placeholder" id="mood-distribution-chart">
                            <p>Mood distribution chart will be displayed here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Entries -->
            <div class="recent-entries-section">
                <h3>Recent Journal Entries</h3>
                <div id="mood-entries-list">
                    <p>No entries yet. Start your mood journal above!</p>
                </div>
            </div>

            <!-- Mood Insights -->
            <div class="mood-insights-section">
                <h3>Mood Insights & Patterns</h3>
                <div class="insights-grid">
                    <div class="insight-card">
                        <h4>🔍 Mood Triggers</h4>
                        <div id="mood-triggers-insight">
                            <p>Track your mood entries to see what consistently affects your mood.</p>
                        </div>
                    </div>
                    <div class="insight-card">
                        <h4>💡 Coping Strategies</h4>
                        <div id="coping-strategies-insight">
                            <p>Review what helps you when you're feeling down.</p>
                        </div>
                    </div>
                    <div class="insight-card">
                        <h4>🌙 Sleep Impact</h4>
                        <div id="sleep-impact-insight">
                            <p>See how sleep quality affects your daily mood.</p>
                        </div>
                    </div>
                    <div class="insight-card">
                        <h4>🎯 Gratitude Practice</h4>
                        <div id="gratitude-practice-insight">
                            <p>Track your gratitude practice and its impact on mood.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mood Goals -->
            <div class="mood-goals-section">
                <h3>Mood & Wellness Goals</h3>
                <form id="mood-goals-form">
                    <div class="form-group">
                        <label for="mood-goal-description">Wellness Goal</label>
                        <textarea id="mood-goal-description" name="goal_description" placeholder="e.g., Practice gratitude daily, improve sleep quality, reduce stress..." rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="mood-goal-deadline">Target Date</label>
                            <input type="date" id="mood-goal-deadline" name="goal_deadline">
                        </div>
                        <div class="form-group">
                            <label for="mood-goal-priority">Priority</label>
                            <select id="mood-goal-priority" name="goal_priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secondary">Add Wellness Goal</button>
                </form>
                
                <div id="mood-goals-list">
                    <h4>Current Goals</h4>
                    <p>No wellness goals set yet.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="work" class="tab-content">
        <div class="sub-tabs work-sub-tabs">
            <button class="sub-tab-button work-sub-tab-button" data-work-sub-tab="dashboard">Dashboard</button>
            <button class="sub-tab-button work-sub-tab-button active" data-work-sub-tab="kanban">Opportunities</button>
            <button class="sub-tab-button work-sub-tab-button" data-work-sub-tab="target-accounts">Target Accounts</button>
        </div>
        <div id="work-kanban-tab" class="work-sub-tab-content active">
            <div class="toolbar">
                <button id="add-opportunity-btn" class="btn-primary">Add New Opportunity</button>
            </div>
            <hr style="margin: 20px 0;">
            <h3>Opportunities</h3>
            <div class="kanban-board" id="kanban-board">
                <!-- Columns will be dynamically loaded here -->
            </div>
        </div>
        <div id="work-target-accounts-tab" class="work-sub-tab-content" style="display:none;">
            <div class="toolbar">
                <button id="add-target-account-btn" class="btn-primary">Add New Account</button>
            </div>
            <hr style="margin: 20px 0;">
            <h3>Target Accounts</h3>
            <div class="kanban-board" id="kanban-target-accounts-board">
                <!-- Target Account columns will be dynamically loaded here -->
            </div>
        </div>
        <div id="work-dashboard-tab" class="work-sub-tab-content" style="display:none;">
            <h3>Dashboard</h3>
            <div id="work-dashboard"></div>
        </div>
    </div>

    <!-- Add Work Entry Modal -->
    <div id="addWorkModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New Opportunity</h2>
            <form id="add-work-form">
                <div class="form-group">
                    <label for="work-opportunity-name">Opportunity Name</label>
                    <input type="text" id="work-opportunity-name" name="opportunity_name" required>
                </div>
                <div class="form-group">
                    <label for="work-next-steps">Next Steps</label>
                    <textarea id="work-next-steps" name="next_steps"></textarea>
                </div>
                <div class="form-group">
                    <label for="work-action-items">Action Items</label>
                    <textarea id="work-action-items" name="action_items"></textarea>
                </div>
                <div class="form-group">
                    <label for="work-arr">ARR</label>
                    <input type="number" id="work-arr" name="arr" step="0.01">
                </div>
                <div class="form-group">
                    <label for="work-cbc">CBC</label>
                    <input type="date" id="work-cbc" name="cbc">
                </div>
                <div class="form-group">
                    <label for="work-status">Status</label>
                    <select id="work-status" name="status">
                        <option value="Q2">Q2</option>
                        <option value="Q3">Q3</option>
                        <option value="Q4">Q4</option>
                        <option value="Q5">Q5</option>
                        <option value="Strategic Opps">Strategic Opps</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="work-next-step-date">Next Step Date</label>
                    <input type="date" id="work-next-step-date" name="next_step_date">
                </div>
                <div class="form-group">
                    <label for="work-risks">Risks</label>
                    <textarea id="work-risks" name="risks"></textarea>
                </div>
                <button type="submit">Save Opportunity</button>
            </form>
        </div>
    </div>

    <!-- Edit Work Entry Modal -->
    <div id="editWorkModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Work Entry</h2>
            <form id="edit-work-form">
                <input type="hidden" id="edit-work-id" name="id">
                <div class="form-group">
                    <label for="edit-opportunity-name">Opportunity Name</label>
                    <input type="text" id="edit-opportunity-name" name="opportunity_name" required>
                </div>
                <div class="form-group">
                    <label for="edit-next-steps">Next Steps</label>
                    <textarea id="edit-next-steps" name="next_steps"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-action-items">Action Items</label>
                    <textarea id="edit-action-items" name="action_items"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-arr">ARR</label>
                    <input type="number" id="edit-arr" name="arr" step="0.01">
                </div>
                <div class="form-group">
                    <label for="edit-cbc">CBC</label>
                    <input type="date" id="edit-cbc" name="cbc">
                </div>
                <div class="form-group">
                    <label for="edit-next-step-date">Next Step Date</label>
                    <input type="date" id="edit-next-step-date" name="next_step_date">
                </div>
                <div class="form-group">
                    <label for="edit-risks">Risks</label>
                    <textarea id="edit-risks" name="risks"></textarea>
                </div>
                <button type="submit">Update Entry</button>
                <button type="button" class="cancel">Cancel</button>
            </form>
        </div>
    </div>

    <div id="snackbar"></div>
</div>

<!-- TDEE Edit Modal -->
<div id="edit-tdee-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button" id="close-edit-tdee-modal">&times;</span>
        <h2>Edit TDEE Record</h2>
        <form id="edit-tdee-form">
            <input type="hidden" id="edit-tdee-id" name="tdee_id">
            <div class="form-group">
                <label for="edit-tdee-date">Date</label>
                <input type="text" id="edit-tdee-date" name="date" readonly>
            </div>
            <div class="form-group">
                <label for="edit-bmr">BMR (Basal Metabolic Rate)</label>
                <input type="number" id="edit-bmr" name="bmr" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-activity-calories">Workout Calories</label>
                <input type="number" id="edit-activity-calories" name="activity_calories" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit-calorie-intake">Calorie Intake</label>
                <input type="number" id="edit-calorie-intake" name="calorie_intake" class="form-control" required>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Trading Modals -->

<!-- Add/Edit Trade Modal -->
<div id="tradeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="tradeModalTitle">Add Trade</h2>
        <form id="tradeForm">
            <input type="hidden" id="editTradeId" name="id">
            <div class="form-row">
                <div class="form-group">
                    <label for="tradeDate">Date</label>
                    <input type="date" id="tradeDate" name="date" required>
                </div>
                <div class="form-group">
                    <label for="tradeAsset">Asset</label>
                    <input type="text" id="tradeAsset" name="asset" placeholder="e.g., AAPL, TSLA" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="tradeType">Trade Type</label>
                    <select id="tradeType" name="trade_type" required>
                        <option value="buy">Buy</option>
                        <option value="sell">Sell</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tradeQuantity">Quantity</label>
                    <input type="number" id="tradeQuantity" name="quantity" step="0.01" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="tradePrice">Price</label>
                    <input type="number" id="tradePrice" name="price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="tradeTotalCost">Total Cost</label>
                    <input type="number" id="tradeTotalCost" name="total_cost" step="0.01" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="tradeFees">Fees</label>
                    <input type="number" id="tradeFees" name="fees" step="0.01" value="0">
                </div>
            </div>
            <div class="form-group">
                <label for="tradeNotes">Notes</label>
                <textarea id="tradeNotes" name="notes" rows="3" placeholder="Trade notes, strategy, etc..."></textarea>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Save Trade</button>
                <button type="button" class="btn btn-secondary cancel">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit P&L Modal -->
<div id="pnlModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="pnlModalTitle">Add P&L Entry</h2>
        <form id="pnlForm">
            <input type="hidden" id="editPnLId" name="id">
            <div class="form-row">
                <div class="form-group">
                    <label for="pnlDate">Date</label>
                    <input type="date" id="pnlDate" name="date" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="pnlStartingBalance">Starting Balance</label>
                    <input type="number" id="pnlStartingBalance" name="starting_balance" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="pnlCurrentBalance">Current Balance</label>
                    <input type="number" id="pnlCurrentBalance" name="current_balance" step="0.01" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="pnlProfitLoss">Profit/Loss</label>
                    <input type="number" id="pnlProfitLoss" name="profit_loss" step="0.01" readonly>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Save P&L</button>
                <button type="button" class="btn btn-secondary cancel">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Weekly Review Modal -->
<div id="weeklyReviewModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="weeklyReviewModalTitle">Add Weekly Review</h2>
        <form id="weeklyReviewForm">
            <input type="hidden" id="editReviewId" name="id">
            <div class="form-row">
                <div class="form-group">
                    <label for="reviewYear">Year</label>
                    <input type="number" id="reviewYear" name="year" required>
                </div>
                <div class="form-group">
                    <label for="reviewWeek">Week</label>
                    <input type="number" id="reviewWeek" name="week" min="1" max="53" required>
                </div>
            </div>
            <div class="form-group">
                <label for="reviewWhatWorked">What Worked</label>
                <textarea id="reviewWhatWorked" name="what_worked" rows="3" placeholder="What strategies or approaches worked well this week?" required></textarea>
            </div>
            <div class="form-group">
                <label for="reviewWhatDidnt">What Didn't Work</label>
                <textarea id="reviewWhatDidnt" name="what_didnt" rows="3" placeholder="What didn't work or what could be improved?" required></textarea>
            </div>
            <div class="form-group">
                <label for="reviewTradeType">Trade Type Analysis</label>
                <textarea id="reviewTradeType" name="trade_type" rows="2" placeholder="Analysis of specific trade types (day trading, swing trading, etc.)"></textarea>
            </div>
            <div class="form-group">
                <label for="reviewMarketTiming">Market Timing</label>
                <textarea id="reviewMarketTiming" name="market_timing" rows="2" placeholder="How was your market timing this week?"></textarea>
            </div>
            <div class="form-group">
                <label for="reviewRecurringProblems">Recurring Problems</label>
                <textarea id="reviewRecurringProblems" name="recurring_problems" rows="2" placeholder="Any patterns or recurring issues you noticed?"></textarea>
            </div>
            <div class="form-group">
                <label for="reviewRecurringPositives">Recurring Positives</label>
                <textarea id="reviewRecurringPositives" name="recurring_positives" rows="2" placeholder="Any positive patterns or strengths you noticed?"></textarea>
            </div>
            <div class="form-group">
                <label for="reviewTasks">Tasks for Next Week</label>
                <textarea id="reviewTasks" name="tasks" rows="3" placeholder="What specific tasks or improvements will you focus on next week?"></textarea>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Save Review</button>
                <button type="button" class="btn btn-secondary cancel">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Upload CSV Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Upload Trades CSV</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label for="csvFile">Select CSV File</label>
                <input type="file" id="csvFile" name="file" accept=".csv" required>
            </div>
            <div class="form-group">
                <p class="help-text">CSV should include columns: date, asset, trade_type, quantity, price, total_cost, fees (optional), notes (optional)</p>
            </div>
            <div class="modal-buttons">
                <button type="submit" class="btn btn-primary">Upload</button>
                <button type="button" class="btn btn-secondary cancel">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="snackbar"></div>

<!-- Edit Stat Modal -->
<div id="edit-stat-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" id="close-edit-stat-modal">&times;</span>
        <h3>Edit Stat Entry</h3>
        <form id="edit-stat-form">
            <input type="hidden" id="edit-stat-id" name="id">
            <div class="form-group">
                <label for="edit-stat-date">Date</label>
                <input type="date" id="edit-stat-date" name="date" required>
            </div>
            <div class="form-group">
                <label for="edit-stat-weight">Weight (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-weight" name="weight">
            </div>
            <div class="form-group">
                <label for="edit-stat-body-fat-percentage">Body Fat %</label>
                <input type="number" step="0.1" id="edit-stat-body-fat-percentage" name="body_fat_percentage">
            </div>
            <div class="form-group">
                <label for="edit-stat-smm">Skeletal Muscle Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-smm" name="smm">
            </div>
            <div class="form-group">
                <label for="edit-stat-body-fat-mass">Body Fat Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-body-fat-mass" name="body_fat_mass">
            </div>
            <div class="form-group">
                <label for="edit-stat-lean-body-mass">Lean Body Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-lean-body-mass" name="lean_body_mass">
            </div>
            <div class="form-group">
                <label for="edit-stat-bmr">BMR (kcal)</label>
                <input type="number" id="edit-stat-bmr" name="bmr">
            </div>
            <div class="form-group">
                <label for="edit-stat-resting-heart-rate">Resting Heart Rate (bpm)</label>
                <input type="number" id="edit-stat-resting-heart-rate" name="resting_heart_rate">
            </div>
            <div class="form-group">
                <label for="edit-stat-bicep-measurement">Bicep (in)</label>
                <input type="number" step="0.1" id="edit-stat-bicep-measurement" name="bicep_measurement">
            </div>
            <div class="form-group">
                <label for="edit-stat-chest-measurement">Chest (in)</label>
                <input type="number" step="0.1" id="edit-stat-chest-measurement" name="chest_measurement">
            </div>
            <div class="form-group">
                <label for="edit-stat-waist-measurement">Waist (in)</label>
                <input type="number" step="0.1" id="edit-stat-waist-measurement" name="waist_measurement">
            </div>
            <div class="form-group">
                <label for="edit-stat-butt-measurement">Butt (in)</label>
                <input type="number" step="0.1" id="edit-stat-butt-measurement" name="butt_measurement">
            </div>
            <div class="form-group">
                <label for="edit-stat-quad-measurement">Quad (in)</label>
                <input type="number" step="0.1" id="edit-stat-quad-measurement" name="quad_measurement">
            </div>
            <div class="form-group">
                <label for="edit-stat-left-arm-lean-mass">Left Arm Lean Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-left-arm-lean-mass" name="left_arm_lean_mass">
            </div>
            <div class="form-group">
                <label for="edit-stat-right-arm-lean-mass">Right Arm Lean Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-right-arm-lean-mass" name="right_arm_lean_mass">
            </div>
            <div class="form-group">
                <label for="edit-stat-left-leg-lean-mass">Left Leg Lean Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-left-leg-lean-mass" name="left_leg_lean_mass">
            </div>
            <div class="form-group">
                <label for="edit-stat-right-leg-lean-mass">Right Leg Lean Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-right-leg-lean-mass" name="right_leg_lean_mass">
            </div>
            <div class="form-group">
                <label for="edit-stat-trunk-lean-mass">Trunk Lean Mass (lbs)</label>
                <input type="number" step="0.1" id="edit-stat-trunk-lean-mass" name="trunk_lean_mass">
            </div>
            <div class="form-group">
                <button type="submit" class="modal-button">Save</button>
                <button type="button" class="modal-button" id="cancel-edit-stat">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Target Account Modal -->
<div id="addTargetAccountModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Add New Target Account</h2>
        <form id="add-target-account-form">
            <div class="form-group">
                <label for="target-account-name">Account Name</label>
                <input type="text" id="target-account-name" name="account_name" required>
            </div>
            <div class="form-group">
                <label for="target-account-description">Description</label>
                <textarea id="target-account-description" name="description"></textarea>
            </div>
            <div class="form-group">
                <label for="target-account-status">Status</label>
                <select id="target-account-status" name="status">
                    <option value="Prospecting">Prospecting</option>
                    <option value="Contacted">Contacted</option>
                    <option value="Qualified">Qualified</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="target-account-notes">Notes</label>
                <textarea id="target-account-notes" name="notes"></textarea>
            </div>
            <div class="form-group">
                <label for="target-account-arr">ARR</label>
                <input type="number" id="target-account-arr" name="arr" step="0.01">
            </div>
            <button type="submit">Save Account</button>
        </form>
    </div>
</div>

<!-- Edit Target Account Modal -->
<div id="editTargetAccountModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Target Account</h2>
        <form id="edit-target-account-form">
            <input type="hidden" id="edit-target-account-id" name="id">
            <div class="form-group">
                <label for="edit-target-account-name">Account Name</label>
                <input type="text" id="edit-target-account-name" name="account_name" required>
            </div>
            <div class="form-group">
                <label for="edit-target-account-description">Description</label>
                <textarea id="edit-target-account-description" name="description"></textarea>
            </div>
            <div class="form-group">
                <label for="edit-target-account-status">Status</label>
                <select id="edit-target-account-status" name="status">
                    <option value="Prospecting">Prospecting</option>
                    <option value="Contacted">Contacted</option>
                    <option value="Qualified">Qualified</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-target-account-notes">Notes</label>
                <textarea id="edit-target-account-notes" name="notes"></textarea>
            </div>
            <div class="form-group">
                <label for="edit-target-account-arr">ARR</label>
                <input type="number" id="edit-target-account-arr" name="arr" step="0.01">
            </div>
            <button type="submit">Update Account</button>
            <button type="button" class="cancel">Cancel</button>
        </form>
    </div>
</div>

<script>
// Work sub-tab switching
const workSubTabs = document.querySelectorAll('.work-sub-tab-button');
const workSubTabContents = {
    kanban: document.getElementById('work-kanban-tab'),
    dashboard: document.getElementById('work-dashboard-tab'),
    targetAccounts: document.getElementById('work-target-accounts-tab')
};
workSubTabs.forEach(btn => {
    btn.addEventListener('click', function() {
        workSubTabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(workSubTabContents).forEach(div => div.style.display = 'none');
        const tab = btn.getAttribute('data-work-sub-tab');
        workSubTabContents[tab].style.display = '';
        if (tab === 'dashboard' && window.renderWorkDashboard) {
            window.renderWorkDashboard();
        }
    });
});

// Trading sub-tab switching
/*
const tradingSubTabs = document.querySelectorAll('#trading .sub-tab-button');
const tradingSubTabContents = {
    dashboard: document.getElementById('trading-dashboard'),
    trades: document.getElementById('trading-trades'),
    pnl: document.getElementById('trading-pnl'),
    reviews: document.getElementById('trading-reviews'),
    calculators: document.getElementById('trading-calculators')
};
tradingSubTabs.forEach(btn => {
    btn.addEventListener('click', function() {
        tradingSubTabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(tradingSubTabContents).forEach(div => div.classList.remove('active'));
        const tab = btn.getAttribute('data-trading-sub-tab');
        tradingSubTabContents[tab].classList.add('active');
    });
});
*/

// Mood sub-tab switching
const moodSubTabs = document.querySelectorAll('.mood-sub-tab-button');
const moodSubTabContents = {
    journal: document.getElementById('mood-journal-tab')
};
moodSubTabs.forEach(btn => {
    btn.addEventListener('click', function() {
        moodSubTabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(moodSubTabContents).forEach(div => div.classList.remove('active'));
        const tab = btn.getAttribute('data-mood-sub-tab');
        moodSubTabContents[tab].classList.add('active');
    });
});

// Food sub-tab switching
const foodSubTabs = document.querySelectorAll('.food-sub-tab-btn');
const foodSubTabContents = {
    manual: document.getElementById('food-tab-manual'),
    barcode: document.getElementById('food-tab-barcode'),
    fasting: document.getElementById('food-tab-fasting'),
    database: document.getElementById('food-tab-database')
};

foodSubTabs.forEach(btn => {
    btn.addEventListener('click', function() {
        foodSubTabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        Object.values(foodSubTabContents).forEach(div => div.classList.remove('active'));
        const tab = btn.getAttribute('data-food-tab');
        foodSubTabContents[tab].classList.add('active');
        
        // Stop scanner if switching away from barcode tab
        if (tab !== 'barcode' && window.isScanning) {
            stopScanner();
        }
    });
});

// Barcode Scanner Functionality
let codeReader = null;
let isScanning = false;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize barcode scanner
    const startScannerBtn = document.getElementById('start-scanner');
    const stopScannerBtn = document.getElementById('stop-scanner');
    const manualBarcodeBtn = document.getElementById('manual-barcode-button');
    
    if (startScannerBtn) {
        startScannerBtn.addEventListener('click', startScanner);
    }
    if (stopScannerBtn) {
        stopScannerBtn.addEventListener('click', stopScanner);
    }
    if (manualBarcodeBtn) {
        manualBarcodeBtn.addEventListener('click', searchByManualBarcode);
    }
    
    // Initialize fasting functionality
    loadFastingData();
    setupFastingEventListeners();
});

function startScanner() {
    if (!codeReader) {
        codeReader = new ZXing.BrowserMultiFormatReader();
    }
    
    codeReader.decodeFromVideoDevice(null, 'scanner-video', (result, err) => {
        if (result) {
            console.log('Barcode detected:', result.text);
            searchByBarcode(result.text);
            stopScanner();
        }
        if (err && !(err instanceof ZXing.NotFoundException)) {
            console.error('Scanner error:', err);
        }
    });
    
    isScanning = true;
    window.isScanning = true;
    document.getElementById('start-scanner').style.display = 'none';
    document.getElementById('stop-scanner').style.display = 'inline-block';
}

function stopScanner() {
    if (codeReader) {
        codeReader.reset();
    }
    isScanning = false;
    window.isScanning = false;
    document.getElementById('start-scanner').style.display = 'inline-block';
    document.getElementById('stop-scanner').style.display = 'none';
}

function searchByManualBarcode() {
    const barcode = document.getElementById('manual-barcode-input').value.trim();
    if (!barcode) {
        alert('Please enter a barcode');
        return;
    }
    searchByBarcode(barcode);
}

function searchByBarcode(barcode) {
    const resultDiv = document.getElementById('barcode-result');
    resultDiv.innerHTML = '<div class="loading">Searching for barcode...</div>';
    
    fetch(`/food/barcode/${barcode}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                resultDiv.innerHTML = `
                    <div class="barcode-error">
                        <strong>Barcode not found:</strong> ${data.error}
                        <br>Barcode: ${data.barcode || barcode}
                    </div>
                `;
                return;
            }
            
            const food = data.food;
            const nutrition = food.nutrition || {};
            const servingSizes = food.common_serving_sizes || [];
            const defaultServing = food.default_serving_size || null;
            let servingOptions = '';
            servingSizes.forEach(serving => {
                servingOptions += `<option value="${serving.id}" ${serving.is_default ? 'selected' : ''}>${serving.description} (${serving.grams_equivalent}g)</option>`;
            });
            
            resultDiv.innerHTML = `
                <div class="barcode-result">
                    <h3>${food.name}</h3>
                    ${food.brand ? `<p><strong>Brand:</strong> ${food.brand}</p>` : ''}
                    ${food.category ? `<p><strong>Category:</strong> ${food.category}</p>` : ''}
                    <p><strong>Barcode:</strong> <span class="barcode">${food.barcode}</span></p>
                    <div class="quantity-group">
                        <label>Serving Size:</label>
                        <select class="barcode-serving-size-select" data-food-id="${food.id}">
                            ${servingOptions}
                        </select>
                        <label>Quantity:</label>
                        <input type="number" id="barcode-quantity" value="1" min="0.1" step="0.1" class="quantity-input">
                    </div>
                    <div class="nutrition-info" id="barcode-nutrition">
                        <div class="nutrition-row">
                            <span class="nutrition-label">Calories:</span>
                            <span class="nutrition-value">${nutrition.calories || 0}</span>
                        </div>
                        <div class="nutrition-row">
                            <span class="nutrition-label">Protein:</span>
                            <span class="nutrition-value">${nutrition.protein || 0}g</span>
                        </div>
                        <div class="nutrition-row">
                            <span class="nutrition-label">Carbs:</span>
                            <span class="nutrition-value">${nutrition.carbs || 0}g</span>
                        </div>
                        <div class="nutrition-row">
                            <span class="nutrition-label">Fat:</span>
                            <span class="nutrition-value">${nutrition.fat || 0}g</span>
                        </div>
                    </div>
                    <button onclick="logFood('${food.name.replace(/'/g, "\\'")}', ${nutrition.calories || 0}, ${nutrition.protein || 0}, ${nutrition.carbs || 0}, ${nutrition.fat || 0}, ${food.id}, true)" class="log-food-btn">
                        Log Food
                    </button>
                </div>
            `;
        })
        .catch(error => {
            console.error('Barcode search error:', error);
            resultDiv.innerHTML = '<div class="barcode-error">Error searching for barcode. Please try again.</div>';
        });
}

// Fasting Functionality
let fastingTimer = null;
let currentFastStartTime = null;

function setupFastingEventListeners() {
    const startBtn = document.getElementById('start-fast-btn');
    const endBtn = document.getElementById('end-fast-btn');
    
    if (startBtn) {
        startBtn.addEventListener('click', startFast);
    }
    if (endBtn) {
        endBtn.addEventListener('click', endFast);
    }
}

function startFast() {
    fetch('/food/fasting/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        currentFastStartTime = new Date(data.start_time);
        updateFastingUI(true);
        startFastingTimer();
        loadFastingData();
    })
    .catch(error => {
        console.error('Error starting fast:', error);
        alert('Error starting fast. Please try again.');
    });
}

function endFast() {
    fetch('/food/fasting/end', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        alert(`Fast ended! Duration: ${data.duration}`);
        updateFastingUI(false);
        stopFastingTimer();
        loadFastingData();
    })
    .catch(error => {
        console.error('Error ending fast:', error);
        alert('Error ending fast. Please try again.');
    });
}

function startFastingTimer() {
    if (fastingTimer) {
        clearInterval(fastingTimer);
    }
    
    fastingTimer = setInterval(updateFastingTimer, 1000);
    updateFastingTimer();
}

function stopFastingTimer() {
    if (fastingTimer) {
        clearInterval(fastingTimer);
        fastingTimer = null;
    }
    currentFastStartTime = null;
}

function updateFastingTimer() {
    if (!currentFastStartTime) return;
    
    const now = new Date();
    const diff = now - currentFastStartTime;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    const timerDisplay = document.getElementById('fasting-timer-display');
    const durationText = document.getElementById('fasting-duration');
    
    if (timerDisplay) {
        timerDisplay.textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    if (durationText) {
        durationText.textContent = `${hours}h ${minutes}m ${seconds}s`;
    }
}

function updateFastingUI(isActive) {
    const startBtn = document.getElementById('start-fast-btn');
    const endBtn = document.getElementById('end-fast-btn');
    const statusDiv = document.getElementById('current-fast-status');
    const timerDisplay = document.getElementById('fasting-timer-display');
    const durationText = document.getElementById('fasting-duration');
    
    if (isActive) {
        startBtn.style.display = 'none';
        endBtn.style.display = 'inline-block';
        statusDiv.classList.add('fasting-active');
        timerDisplay.textContent = '00:00:00';
        durationText.textContent = 'Fast in progress...';
    } else {
        startBtn.style.display = 'inline-block';
        endBtn.style.display = 'none';
        statusDiv.classList.remove('fasting-active');
        timerDisplay.textContent = '--:--:--';
        durationText.textContent = 'Not fasting';
    }
}

function loadFastingData() {
    // Load current fast status
    fetch('/food/fasting/current')
        .then(response => response.json())
        .then(data => {
            if (data.active) {
                currentFastStartTime = new Date(data.start_time);
                updateFastingUI(true);
                startFastingTimer();
            } else {
                updateFastingUI(false);
            }
        })
        .catch(error => console.error('Error loading current fast:', error));
    
    // Load fasting stats
    fetch('/food/fasting/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-fasts').textContent = data.total_fasts;
            document.getElementById('total-hours').textContent = data.total_hours;
            document.getElementById('longest-fast').textContent = formatDuration(data.longest_fast);
            document.getElementById('average-fast').textContent = formatDuration(data.average_fast);
        })
        .catch(error => console.error('Error loading fasting stats:', error));
    
    // Load fasting history
    fetch('/food/fasting/history')
        .then(response => response.json())
        .then(data => {
            const historyList = document.getElementById('fasting-history-list');
            
            if (data.history.length === 0) {
                historyList.innerHTML = '<p class="no-history">No fasting history yet. Start your first fast!</p>';
                return;
            }
            
            const historyHTML = data.history.map(fast => {
                const startDate = new Date(fast.start_time);
                const endDate = fast.end_time ? new Date(fast.end_time) : null;
                const dateStr = startDate.toLocaleDateString();
                const timeStr = startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                return `
                    <div class="history-item">
                        <div class="history-date">
                            <div>${dateStr}</div>
                            <div style="font-size: 12px; color: #999;">${timeStr}</div>
                        </div>
                        <div class="history-duration">${fast.duration}</div>
                    </div>
                `;
            }).join('');
            
            historyList.innerHTML = historyHTML;
        })
        .catch(error => console.error('Error loading fasting history:', error));
}

function formatDuration(minutes) {
    if (!minutes || minutes === 0) return '0h';
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    if (hours > 0) {
        return remainingMinutes > 0 ? `${hours}h ${remainingMinutes}m` : `${hours}h`;
    } else {
        return `${remainingMinutes}m`;
    }
}

// Add navigation logic for Trading sub-tabs
document.addEventListener('DOMContentLoaded', function() {
    const tradingTab = document.getElementById('trading');
    if (tradingTab) {
        const subTabs = tradingTab.querySelectorAll('.sub-tab-button');
        const subTabContents = tradingTab.querySelectorAll('.sub-tab-content');
        subTabs.forEach(btn => {
            btn.addEventListener('click', function() {
                subTabs.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const tab = btn.getAttribute('data-trading-sub-tab');
                subTabContents.forEach(content => {
                    if (content.id === `trading-${tab}`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
            });
        });
    }
});
</script>

<!-- Temporary audio test fallback -->
<script>
    // Fallback test function if the main one isn't loaded
    window.testAudio = window.testAudio || function() {
        console.log('Using fallback testAudio function...');
        const audio = new Audio('/static/sounds/pr-achievement.mp3');
        audio.volume = 0.6;
        audio.play().then(() => {
            console.log('Audio played successfully!');
            if (window.showSnack) {
                window.showSnack('Audio test successful! 🎵', 'success');
            } else {
                alert('Audio test successful! 🎵');
            }
        }).catch(e => {
            console.log('Audio play failed:', e);
            if (window.showSnack) {
                window.showSnack('Audio test failed: ' + e.message, 'error');
            } else {
                alert('Audio test failed: ' + e.message);
            }
        });
    };
</script>

<!-- Start a Workout Modal -->
<div id="start-workout-modal" class="modal" style="display:none; background: rgba(0,0,0,0.25); align-items: center; justify-content: center;">
    <div class="modal-content" style="max-width: 600px; margin: 40px auto; padding: 32px 28px 20px 28px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); background: #fff; position: relative;">
        <span class="close" id="close-start-workout-modal" style="position: absolute; right: 18px; top: 12px; font-size: 1.6em; cursor: pointer;">&times;</span>
        
        <!-- Step 1: Choose workout option -->
        <div id="start-workout-step-1">
            <h2 style="margin: 0 0 16px 0; font-size: 1.5em;">Start a Workout</h2>
            <p style="margin-bottom: 24px; color: #666;">Choose how you'd like to start your workout:</p>
            
            <div style="display: flex; gap: 16px; margin-bottom: 24px;">
                <button onclick="createNewWorkout()" class="btn btn-primary" style="flex: 1; padding: 16px; font-size: 1.1em;">
                    <div style="margin-bottom: 8px;">🏗️</div>
                    <strong>Create New Workout</strong>
                    <div style="font-size: 0.9em; margin-top: 4px;">Build a custom workout template</div>
                </button>
            </div>
            
            <div style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 12px; font-size: 1.1em;">Saved Workout Templates</h3>
                <div id="workout-template-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 12px;">
                    <p style="text-align: center; color: #666;">Loading templates...</p>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Create new workout - Name -->
        <div id="start-workout-step-2" style="display:none;">
            <h2 style="margin: 0 0 16px 0; font-size: 1.5em;">Create New Workout</h2>
            <div class="form-group">
                <label for="workout-template-name">Workout Name</label>
                <input type="text" id="workout-template-name" class="form-input" placeholder="e.g., Leg Day, Push Day, Chest, etc." required maxlength="100">
            </div>
            <div style="margin-top: 24px; display: flex; justify-content: space-between;">
                <button onclick="backToWorkoutSelection()" class="btn btn-secondary">Back</button>
                <button onclick="nextToExerciseSelection()" class="btn btn-primary">Next</button>
            </div>
        </div>
        
        <!-- Step 3: Create new workout - Categories and Exercises -->
        <div id="start-workout-step-3" style="display:none;">
            <h2 style="margin: 0 0 16px 0; font-size: 1.3em;">Select Categories & Exercises</h2>
            
            <div style="margin-bottom: 24px;">
                <h4 style="margin-bottom: 12px;">Step 1: Select Categories</h4>
                <div id="multi-category-list" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; justify-content: center;"></div>
                <button onclick="loadExercisesForSelectedCategories()" class="btn btn-secondary" style="margin-bottom: 16px;">Load Exercises for Selected Categories</button>
            </div>
            
            <div style="margin-bottom: 24px;">
                <h4 style="margin-bottom: 12px;">Step 2: Select Exercises</h4>
                <div id="multi-exercise-list" style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; justify-content: center; min-height: 60px; border: 1px solid #eee; border-radius: 8px; padding: 12px;">
                    <p style="text-align: center; color: #666; width: 100%;">Select categories above to load exercises</p>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between;">
                <button onclick="backToCategories()" class="btn btn-secondary">Back</button>
                <button onclick="saveWorkoutTemplate()" class="btn btn-primary">Save Workout Template</button>
            </div>
        </div>
        
        <!-- Step 4: Success -->
        <div id="start-workout-step-4" style="display:none; text-align: center;">
            <h2 style="margin: 0 0 16px 0; font-size: 1.3em;">✅ Workout Template Saved!</h2>
            <p style="margin-bottom: 24px;">Your workout template has been saved successfully. You can now select it when starting a workout.</p>
            <button onclick="closeWorkoutTemplateSuccess()" class="btn btn-primary">Close</button>
        </div>
    </div>
  </div>
  </body>
  </html>